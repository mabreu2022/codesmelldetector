                                                                                       unit uProjeto;

interface

uses
  System.SysUtils, System.Classes, System.Generics.Collections;

function ObterArquivosDoProjeto(const ProjetoPath: string): TArray<string>;

implementation

uses
  System.IOUtils, Xml.XMLDoc, Xml.XMLIntf;

function ObterArquivosDoProjeto(const ProjetoPath: string): TArray<string>;
var
  DprojFile: string;
  XML: IXMLDocument;
  Root, ItemGroup, Ref: IXMLNode;
  Lista: TList<string>;
  BaseDir, FilePath: string;
  PastasIgnoradas: TArray<string>;
  Ignorar: Boolean;
  Pasta: string;
  i, j: Integer;
begin
  Lista := TList<string>.Create;
  try
    // Localiza o primeiro .dproj no diretório
    DprojFile := '';
    for i := 0 to TDirectory.GetFiles(ProjetoPath, '*.dproj').Length - 1 do
    begin
      DprojFile := TDirectory.GetFiles(ProjetoPath, '*.dproj')[i];
      Break;
    end;

    if DprojFile = '' then
      raise Exception.Create('Arquivo .dproj não encontrado no diretório.');

    XML := TXMLDocument.Create(nil);
    XML.LoadFromFile(DprojFile);
    XML.Active := True;

    BaseDir := ExtractFilePath(DprojFile);
    PastasIgnoradas := ['\lib\', '\thirdparty\', '\vendor\', '\external\', '\packages\'];

    Root := XML.DocumentElement;

    for i := 0 to Root.ChildNodes.Count - 1 do
    begin
      ItemGroup := Root.ChildNodes[i];
      if SameText(ItemGroup.NodeName, 'ItemGroup') then
      begin
        for j := 0 to ItemGroup.ChildNodes.Count - 1 do
        begin
          Ref := ItemGroup.ChildNodes[j];
          if SameText(Ref.NodeName, 'DCCReference') then
          begin
            if Ref.HasAttribute('Include') then
            begin
              FilePath := TPath.Combine(BaseDir, Ref.Attributes['Include']);
              FilePath := TPath.GetFullPath(FilePath);

              Ignorar := False;
              for Pasta in PastasIgnoradas do
                if FilePath.ToLower.Contains(Pasta) then
                begin
                  Ignorar := True;
                  Break;
                end;

              if not Ignorar and TFile.Exists(FilePath) then
                Lista.Add(FilePath);
            end;
          end;
        end;
      end;
    end;

    Result := Lista.ToArray;
  finally
    Lista.Free;
  end;
end;

end.
